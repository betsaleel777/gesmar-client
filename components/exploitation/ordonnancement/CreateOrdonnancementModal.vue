<template>
  <b-modal id="modalCreateOrdonnancement" size="lg" scrollable @show="reset">
    <template #modal-header>
      <h5 id="archiver" class="modal-title text-primary">Ordonnancer des factures</h5>
      <button type="button" class="close" aria-label="Close" @click="reset">
        <span aria-hidden="true"><feather type="x" /></span>
      </button>
    </template>
    <template #default>
      <form ref="form">
        <v-app>
          <v-autocomplete
            v-model="contrat"
            :items="contrats"
            item-text="alias"
            item-value="id"
            outlined
            dense
            @change="getFactures"
          >
            <template #label>
              Contrat
              <span class="red--text"><strong>* </strong></span>
            </template>
          </v-autocomplete>
          <v-row>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesInitiales.selected"
                :items="facturesInitiales.items"
                item-text="code"
                item-value="id"
                outlined
                return-object
                multiple
                chips
                small-chips
                deletable-chips
                dense
                :loading="loading"
                @change="pushInitiale"
              >
                <template #label> Factures Initiales </template>
                <template #progress>
                  <v-progress-linear
                    v-if="loading"
                    indeterminate
                    color="primary"
                    absolute
                  ></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesLoyers.selected"
                :items="facturesLoyers.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                multiple
                chips
                small-chips
                deletable-chips
                return-object
                :loading="loading"
                @change="pushLoyer"
              >
                <template #label> Factures de loyer </template>
                <template #progress>
                  <v-progress-linear
                    v-if="loading"
                    indeterminate
                    color="primary"
                    absolute
                  ></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesEquipements.selected"
                :items="facturesEquipements.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                multiple
                chips
                small-chips
                deletable-chips
                return-object
                :loading="loading"
                @change="pushEquipement"
              >
                <template #label> Factures d'équipement </template>
                <template #progress>
                  <v-progress-linear
                    v-if="loading"
                    indeterminate
                    color="primary"
                    absolute
                  ></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesAnnexes.selected"
                :items="facturesAnnexes.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                multiple
                chips
                small-chips
                deletable-chips
                return-object
                :loading="loading"
                @change="pushAnnexe"
              >
                <template #label> Factures Annexes </template>
                <template #progress>
                  <v-progress-linear
                    v-if="loading"
                    indeterminate
                    color="primary"
                    absolute
                  ></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
          </v-row>
          <v-container v-if="ordonnancement.paiements.length > 0">
            <v-simple-table dense>
              <template #default>
                <thead>
                  <tr>
                    <th class="text-left">Code</th>
                    <th class="text-left">Montant total</th>
                    <th class="text-left">Montant A payer</th>
                    <th class="text-right">Reste à payer</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(paiement, index) in ordonnancement.paiements" :key="index">
                    <td>{{ paiement.code }}</td>
                    <td>{{ paiement.aPayer | currency }}</td>
                    <td v-if="paiement.type === types[1]">
                      <v-text-field v-model="paiement.montant" dense></v-text-field>
                    </td>
                    <td v-else>{{ paiement.montant | currency }}</td>
                    <td class="text-right">
                      {{ (Number(paiement.aPayer) - Number(paiement.montant)) | currency }}
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" class="text-right"></td>
                    <td class="text-right">
                      <b>Total:{{ total | currency }}</b>
                    </td>
                  </tr>
                </tfoot>
              </template>
            </v-simple-table>
          </v-container>
        </v-app>
      </form>
    </template>
    <template #modal-footer>
      <button type="button" class="btn btn-warning" data-dismiss="modal" @click="reset">Fermer</button>
      <button
        type="button"
        :disabled="!validable || submiting"
        class="btn btn-primary text-white"
        @click="save"
      >
        Valider
      </button>
    </template>
  </b-modal>
</template>
<script>
import { mapActions, mapGetters } from 'vuex'
export default {
  data: () => ({
    loading: false,
    submiting: false,
    ordonnancement: {
      total: 0,
      paiements: [],
    },
    contrat: null,
    types: {
      1: 'facture initiale',
      2: 'facture de loyer',
      3: "facture d'équipement",
      4: 'facture annexe',
    },
    facturesEquipements: {
      selected: [],
      items: [],
    },
    facturesInitiales: {
      selected: [],
      items: [],
    },
    facturesAnnexes: {
      selected: [],
      items: [],
    },
    facturesLoyers: {
      selected: [],
      items: [],
    },
  }),
  computed: {
    ...mapGetters({ contrats: 'exploitation/contrat/contrats' }),
    total() {
      let somme = 0
      this.ordonnancement.paiements.forEach(({ montant }) => {
        somme += Number(montant)
      })
      return somme
    },
    missingMontant() {
      return this.ordonnancement.paiements.some(({ montant }) => montant === 0)
    },
    paiementsExist() {
      return this.ordonnancement.paiements.length > 0
    },
    negativePaiement() {
      return this.ordonnancement.paiements.some((paiement) => paiement.aPayer - paiement.montant < 0)
    },
    validable() {
      return this.paiementsExist && !this.missingMontant && !this.negativePaiement
    },
  },
  mounted() {
    this.getContrats()
  },
  methods: {
    ...mapActions({
      ajouter: 'exploitation/ordonnancement/ajouter',
      getContrats: 'exploitation/contrat/getContratsForScheduleView',
      getFacturesByContrat: 'facture/facture/getByContrat',
    }),
    save() {
      this.submiting = true
      this.ordonnancement.total = this.total
      this.ajouter(this.ordonnancement).then(({ message }) => {
        this.submiting = false
        this.$bvModal.hide('modalCreateOrdonnancement')
        this.$bvToast.toast(message, {
          title: 'succès de la création'.toLocaleUpperCase(),
          variant: 'success',
          solid: true,
        })
      })
    },
    pushInitiale() {
      const initiales = []
      this.removeByType(1)
      this.facturesInitiales.selected.forEach(
        ({ id, code, pas_porte: pas, caution, contrat, sommeVersee }) => {
          const loyer = Number(contrat.emplacement.loyer)
          const aPayer = Number(caution) * loyer + Number(pas)
          initiales.push({
            code,
            id,
            type: this.types[1],
            montant: 0,
            aPayer: Number(aPayer) - Number(sommeVersee),
          })
        }
      )
      this.ordonnancement.paiements.push(...initiales)
    },
    pushLoyer() {
      const loyers = []
      this.removeByType(2)
      this.facturesLoyers.selected.forEach(({ id, code, contrat }) => {
        const loyer = Number(contrat.emplacement.loyer)
        loyers.push({ code, id, type: this.types[2], montant: loyer, aPayer: loyer })
      })
      this.ordonnancement.paiements.push(...loyers)
    },
    pushEquipement() {
      const equipements = []
      this.removeByType(3)
      this.facturesEquipements.selected.forEach(({ id, code, index_depart, index_fin, equipement }) => {
        const cout = (index_fin - index_depart) * equipement.prix_fixe
        equipements.push({ code, id, type: this.types[3], montant: cout, aPayer: cout })
      })
      this.ordonnancement.paiements.push(...equipements)
    },
    pushAnnexe() {
      const annexes = []
      this.removeByType(4)
      this.facturesAnnexes.selected.forEach(({ id, code, contrat }) => {
        const prix = Number(contrat.annexe.prix)
        annexes.push({ code, id, type: this.types[4], montant: prix, aPayer: prix })
      })
      this.ordonnancement.paiements.push(...annexes)
    },
    reset() {
      this.ordonnancement = { total: 0, paiements: [] }
      this.$bvModal.hide('modalCreateOrdonnancement')
      this.facturesEquipements = {
        selected: [],
        items: [],
      }
      this.facturesInitiales = {
        selected: [],
        items: [],
      }
      this.facturesLoyers = {
        selected: [],
        items: [],
      }
      this.facturesAnnexes = {
        selected: [],
        items: [],
      }
      this.contrat = null
    },
    removeByType(type) {
      this.ordonnancement.paiements = this.ordonnancement.paiements.filter(
        (paiement) => paiement.type !== this.types[type]
      )
    },
    async getFactures() {
      this.loading = true
      this.ordonnancement.paiements = []
      const { facturesEquipements, facturesInitiales, facturesLoyers, facturesAnnexes } =
        await this.getFacturesByContrat(this.contrat)
      this.facturesEquipements.items = facturesEquipements
      this.facturesLoyers.items = facturesLoyers
      this.facturesInitiales.items = facturesInitiales
      this.facturesAnnexes.items = facturesAnnexes
      this.loading = false
    },
  },
}
</script>
<style></style>
