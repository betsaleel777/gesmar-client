<template>
  <b-modal id="modalCreateOrdonnancement" size="lg" scrollable @show="reset">
    <template #modal-header>
      <h5 id="archiver" class="modal-title text-primary">Ordonnancer des factures</h5>
      <button type="button" class="close" aria-label="Close" @click="reset">
        <span aria-hidden="true"><feather type="x" /></span>
      </button>
    </template>
    <template #default>
      <form ref="form">
        <v-app>
          <v-autocomplete
            v-model="contrat"
            :items="contrats"
            item-text="alias"
            item-value="id"
            outlined
            dense
            @change="getFactures"
          >
            <template #label>
              Contrat
              <span class="red--text"><strong>* </strong></span>
            </template>
          </v-autocomplete>
          <v-row>
            <v-col cols="4" sm="4">
              <v-autocomplete
                v-model="facturesInitiales.selected"
                :items="facturesInitiales.items"
                item-text="code"
                item-value="id"
                outlined
                return-object
                multiple
                dense
                :loading="loading"
                @change="paiementPush(1)"
              >
                <template #label> Factures Initiales </template>
                <template #progress>
                  <v-progress-linear
                    v-if="loading"
                    indeterminate
                    color="primary"
                    absolute
                  ></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="4" sm="4">
              <v-autocomplete
                v-model="facturesLoyers.selected"
                :items="facturesLoyers.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                multiple
                return-object
                :loading="loading"
                @change="paiementPush(2)"
              >
                <template #label> Factures de loyer </template>
                <template #progress>
                  <v-progress-linear
                    v-if="loading"
                    indeterminate
                    color="primary"
                    absolute
                  ></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="4" sm="4">
              <v-autocomplete
                v-model="facturesEquipements.selected"
                :items="facturesEquipements.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                multiple
                return-object
                :loading="loading"
                @change="paiementPush(3)"
              >
                <template #label> Factures d'équipement </template>
                <template #progress>
                  <v-progress-linear
                    v-if="loading"
                    indeterminate
                    color="primary"
                    absolute
                  ></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
          </v-row>
          <v-container v-if="ordonnancement.paiements.length > 0">
            <v-simple-table dense>
              <template #default>
                <thead>
                  <tr>
                    <th class="text-left">Code</th>
                    <th class="text-left">Type</th>
                    <th class="text-left">A payer</th>
                    <th class="text-left">Déjà versé</th>
                    <th class="text-left">Montant</th>
                    <th class="text-left">Reste</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(paiement, index) in ordonnancement.paiements" :key="index">
                    <td>{{ paiement.code }}</td>
                    <td>{{ paiement.type }}</td>
                    <td>{{ paiement.aPayer }}</td>
                    <td>{{ paiement.somme }}</td>
                    <td v-if="paiement.type === types[1]">
                      <v-text-field
                        v-model="paiement.montant"
                        type="number"
                        :min="0"
                        :max="paiement.aPayer"
                        dense
                        single-line
                      ></v-text-field>
                    </td>
                    <td v-else>{{ paiement.montant }}</td>
                    <td>{{ Number(paiement.aPayer) - Number(paiement.montant) - Number(paiement.somme) }}</td>
                  </tr>
                </tbody>
              </template>
            </v-simple-table>
            <v-spacer></v-spacer>
            <span>Total: {{ total }}</span>
          </v-container>
        </v-app>
      </form>
    </template>
    <template #modal-footer>
      <button type="button" class="btn btn-warning" data-dismiss="modal" @click="reset">Fermer</button>
      <button type="button" class="btn btn-primary" @click="save">Valider</button>
    </template>
  </b-modal>
</template>
<script>
import { isNull } from 'url/util'
import { mapActions, mapGetters } from 'vuex'
let message = ''
export default {
  data: () => ({
    loading: false,
    ordonnancement: {
      total: 0,
      paiements: [],
    },
    contrat: null,
    types: {
      1: 'facture initiale',
      2: 'facture de loyer',
      3: "facture d'équipement",
    },
    facturesEquipements: {
      selected: [],
      items: [],
    },
    facturesInitiales: {
      selected: [],
      items: [],
    },
    facturesLoyers: {
      selected: [],
      items: [],
    },
  }),
  computed: {
    ...mapGetters({ contrats: 'exploitation/contrat/contrats' }),
    total() {
      let somme = 0
      this.ordonnancement.paiements.forEach(({ montant }) => {
        somme += Number(montant)
      })
      return somme
    },
    missingMontant() {
      const missing = this.ordonnancement.paiements.some(({ montant }) => isNull(montant))
      if (missing) message += 'le montant à payer par le locataire est requis.'
      return missing
    },
    paiementsExist() {
      const exist = this.ordonnancement.paiements.length > 0
      if (!exist) message += "Aucune facture n'a encore été selectionnée."
      return exist
    },
    factureSoldee() {
      const soldee = this.ordonnancement.paiements.some(
        ({ aPayer, somme }) => Number(aPayer) === Number(somme)
      )
      if (soldee) message += 'les factures déjà ordonnancée ne peuvent être payée à nouveau'
      return soldee
    },
    resteNegatif() {
      const negatif = this.ordonnancement.paiements.some(
        ({ montant, aPayer, somme }) => Number(aPayer) - Number(montant) - Number(somme) < 0
      )
      if (negatif) message += 'erreur de valeur du montant'
      return negatif
    },
  },
  mounted() {
    this.getContrats()
  },
  methods: {
    ...mapActions({
      ajouter: 'exploitation/ordonnancement/ajouter',
      getContrats: 'exploitation/contrat/getContratsForScheduleView',
      getFacturesByContrat: 'facture/facture/getByContrat',
    }),
    save() {
      if (this.validable()) {
        this.ordonnancement.total = this.total
        this.ajouter(this.ordonnancement).then(({ message }) => {
          this.$bvModal.hide('modalCreateOrdonnancement')
          this.$bvToast.toast(message, {
            title: 'succès de la création'.toLocaleUpperCase(),
            variant: 'success',
            solid: true,
          })
        })
      } else {
        this.$bvToast.toast(message, {
          title: "échec de l'opération".toLocaleUpperCase(),
          variant: 'danger',
          solid: true,
        })
        message = ''
      }
    },
    paiementPush(type) {
      if (type === 1) {
        const initiales = []
        this.facturesInitiales.selected.forEach(
          ({ id, code, pas_porte: pas, caution, avance, contrat, sommeVersee }) => {
            const loyer = Number(contrat.emplacement.loyer)
            const aPayer = Number(caution) * loyer + Number(pas)
            initiales.push({
              code,
              id,
              type: this.types[type],
              montant: Number(sommeVersee) === 0 ? Number(avance) * loyer : 0,
              aPayer: Number(aPayer),
              somme: Number(sommeVersee),
            })
          }
        )
        this.ordonnancement.paiements.push(...initiales)
      }
      if (type === 2) {
        const loyers = []
        this.facturesLoyers.selected.forEach(({ id, code, contrat }) => {
          const loyer = Number(contrat.emplacement.loyer)
          loyers.push({ code, id, type: this.types[type], montant: loyer, aPayer: loyer })
        })
        this.ordonnancement.paiements.push(...loyers)
      }
      if (type === 3) {
        const equipements = []
        this.facturesEquipements.selected.forEach(({ id, code }) => {
          equipements.push({ code, id, type: this.types[type], montant: 0 })
        })
        this.ordonnancement.paiements.push(...equipements)
      }
    },
    validable() {
      return this.paiementsExist && !this.missingMontant && !this.resteNegatif && !this.factureSoldee
    },
    reset() {
      this.ordonnancement = { total: 0, paiements: [] }
      this.$bvModal.hide('modalCreateOrdonnancement')
      this.facturesEquipements = {
        selected: [],
        items: [],
      }
      this.facturesInitiales = {
        selected: [],
        items: [],
      }
      this.facturesLoyers = {
        selected: [],
        items: [],
      }
      this.contrat = null
    },
    async getFactures() {
      this.loading = true
      const { facturesEquipements, facturesInitiales, facturesLoyers } = await this.getFacturesByContrat(
        this.contrat
      )
      this.facturesEquipements.items = facturesEquipements
      this.facturesLoyers.items = facturesLoyers
      this.facturesInitiales.items = facturesInitiales
      this.loading = false
    },
  },
}
</script>
<style></style>
