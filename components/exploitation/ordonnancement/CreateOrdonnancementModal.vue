<template>
  <b-modal v-model="dialog" size="lg" scrollable>
    <template #modal-header>
      <h5 id="archiver" class="modal-title text-primary">Ordonnancer des factures</h5>
      <button type="button" class="close" aria-label="Close" @click="dialog = false">
        <span aria-hidden="true"><feather type="x" /></span>
      </button>
    </template>
    <template #default>
      <b-overlay :show="$fetchState.pending || submiting" spinner-variant="primary" rounded="sm">
        <v-app>
          <v-row>
            <v-col sm="6" md="6">
              <v-autocomplete
                v-model="ordonnancement.contrat"
                :items="contrats"
                item-text="texte"
                item-value="id"
                outlined
                dense
                :error="errors.hasOwnProperty('contrat')"
                :error-messages="errors.contrat"
                @change="getFactures"
              >
                <template #label>
                  Contrat
                  <span class="red--text"><strong>* </strong></span>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col sm="6" md="6">
              <v-select
                v-model="ordonnancement.nature_paiement"
                dense
                outlined
                :error="errors.hasOwnProperty('nature_paiement')"
                :error-messages="errors.nature_paiement"
                :items="naturesPaiements"
                ><template #label>
                  Nature de Paiement
                  <span class="red--text"><strong>* </strong></span>
                </template></v-select
              >
            </v-col>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesInitiales.selected"
                :items="facturesInitiales.items"
                item-text="code"
                item-value="id"
                outlined
                return-object
                multiple
                chips
                small-chips
                deletable-chips
                dense
                :loading="loading"
                @change="pushInitiale"
              >
                <template #label> Factures Initiales </template>
                <template #progress>
                  <v-progress-linear v-if="loading" indeterminate color="primary" absolute></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesLoyers.selected"
                :items="facturesLoyers.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                multiple
                chips
                small-chips
                deletable-chips
                return-object
                :loading="loading"
                @change="pushLoyer"
              >
                <template #label> Factures de loyer </template>
                <template #progress>
                  <v-progress-linear v-if="loading" indeterminate color="primary" absolute></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesEquipements.selected"
                :items="facturesEquipements.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                multiple
                chips
                small-chips
                deletable-chips
                return-object
                :loading="loading"
                @change="pushEquipement"
              >
                <template #label> Factures d'équipement </template>
                <template #progress>
                  <v-progress-linear v-if="loading" indeterminate color="primary" absolute></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesAnnexes.selected"
                :items="facturesAnnexes.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                return-object
                :loading="loading"
                @change="pushAnnexe"
              >
                <template #label> Factures Annexes </template>
                <template #progress>
                  <v-progress-linear v-if="loading" indeterminate color="primary" absolute></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
          </v-row>
          <p v-if="errors.hasOwnProperty('paiements')" class="red--text">{{ errors.paiements }}</p>
          <v-container v-if="ordonnancement.paiements.length > 0">
            <v-simple-table dense>
              <template #default>
                <thead>
                  <tr>
                    <th class="text-left">Code</th>
                    <th class="text-left">Montant total</th>
                    <th class="text-left">Montant à payer</th>
                    <th class="text-right">Reste à payer</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(paiement, index) in ordonnancement.paiements" :key="index">
                    <td>{{ paiement.code }}</td>
                    <td>{{ paiement.aPayer | currency }}</td>
                    <td v-if="paiement.type === types[3]">
                      {{ paiement.montant | currency }}
                    </td>
                    <td v-else>
                      <v-text-field
                        v-model.number="paiement.montant"
                        :readonly="paiement.readonly"
                        :error="errors.hasOwnProperty(`paiements.${index}.montant`)"
                        :error-messages="errors[`paiements.${index}.montant`]"
                        dense
                      ></v-text-field>
                    </td>
                    <td class="text-right">
                      {{ (Number(paiement.aPayer) - Number(paiement.montant)) | currency }}
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" class="text-right"></td>
                    <td><v-text-field v-model.number="ordonnancement.timbre" hint="timbre" class="w-50 float-right" dense></v-text-field></td>
                  </tr>
                  <tr>
                    <td colspan="3" class="text-right"></td>
                    <td class="text-right">
                      <b>Total:{{ total | currency }}</b>
                    </td>
                  </tr>
                </tfoot>
              </template>
            </v-simple-table>
          </v-container>
        </v-app>
      </b-overlay>
    </template>
    <template #modal-footer>
      <button type="button" class="btn btn-warning" data-dismiss="modal" @click="dialog = false">Fermer</button>
      <button type="button" :disabled="submiting" class="btn btn-primary text-white" @click="save">Valider</button>
    </template>
  </b-modal>
</template>
<script>
import { mapActions, mapGetters } from 'vuex'
import { MODULES } from '~/helper/modules-types'
import { NATURES_PAIEMENT } from '~/helper/constantes'
import modal from '~/mixins/modal'
export default {
  mixins: [modal],
  data: () => ({
    loading: false,
    submiting: false,
    naturesPaiements: NATURES_PAIEMENT,
    ordonnancement: {
      contrat: null,
      total: 0,
      paiements: [],
      nature_paiement: null,
      timbre: 0,
    },
    types: {
      1: 'facture initiale',
      2: 'facture de loyer',
      3: "facture d'équipement",
      4: 'facture annexe',
    },
    facturesEquipements: {
      selected: [],
      items: [],
    },
    facturesInitiales: {
      selected: [],
      items: [],
    },
    facturesAnnexes: {
      selected: null,
      items: [],
    },
    facturesLoyers: {
      selected: [],
      items: [],
    },
  }),
  async fetch() {
    try {
      if (Object.keys(this.societe).length === 0) await this.getSociete()
      await this.getContrats()
    } catch (error) {
      this.$notify({ text: error.response.data.message, type: 'error', title: 'Echec Autorisation' })
    }
  },
  computed: {
    ...mapGetters({ contrats: MODULES.CONTRAT.GETTERS.CONTRATS, societe: MODULES.APPLICATION.GETTERS.SOCIETE }),
    subtotal() {
      let somme = 0
      this.ordonnancement.paiements.forEach(({ montant }) => {
        somme += Number(montant)
      })
      return somme
    },
    total() {
      return this.subtotal + this.ordonnancement.timbre
    },
    initialeOnly() {
      return this.facturesEquipements.items.length === 0 && this.facturesLoyers.items.length === 0
    },
    missingMontant() {
      return this.ordonnancement.paiements.some(({ montant }) => Number(montant) === 0)
    },
    paiementsExist() {
      return this.ordonnancement.paiements.length > 0
    },
    negativePaiement() {
      return this.ordonnancement.paiements.some((paiement) => paiement.aPayer - paiement.montant < 0)
    },
    validable() {
      return this.paiementsExist && !this.missingMontant && !this.negativePaiement
    },
  },
  methods: {
    ...mapActions({
      ajouter: MODULES.ORDONNANCEMENT.ACTIONS.ADD,
      getContrats: MODULES.CONTRAT.ACTIONS.SCHEDULE_VIEW,
      getFacturesByContrat: MODULES.FACTURE.ACTIONS.BY_CONTRAT,
      getSociete: MODULES.APPLICATION.ACTIONS.ONE,
    }),
    save() {
      this.submiting = true
      this.ordonnancement.total = this.subtotal
      this.ajouter(this.ordonnancement)
        .then(({ message }) => {
          this.submiting = false
          this.dialog = false
          this.$notify({ text: message, title: "succès de l'opération", type: 'success' })
        })
        .catch((err) => {
          this.fillErrors(err.response.data.errors)
        })
        .finally(() => (this.submiting = false))
    },
    pushInitiale() {
      const initiales = []
      this.removeByType(1)
      this.facturesInitiales.selected.forEach(
        ({ id, code, pas_porte: pas, caution, avance, frais_dossier, frais_amenagement, sommeVersee, contrat: { apport } }) => {
          const aPayer = Number(caution) + Number(avance) + Number(pas) + Number(frais_dossier) + Number(frais_amenagement)
          initiales.push({
            code,
            id,
            type: this.types[1],
            montant: this.initialeOnly && sommeVersee === 0 ? apport : 0,
            aPayer: Number(aPayer) - Number(sommeVersee),
            readonly: !sommeVersee >= apport,
          })
        }
      )
      this.ordonnancement.paiements.push(...initiales)
    },
    pushLoyer() {
      const loyers = []
      this.removeByType(2)
      this.facturesLoyers.selected.forEach(({ id, code, loyer, sommeVersee }) => {
        const reste = Number(loyer) - Number(sommeVersee)
        loyers.push({ code, id, type: this.types[2], montant: reste, aPayer: reste, readonly: false })
      })
      this.ordonnancement.paiements.push(...loyers)
    },
    pushEquipement() {
      const equipements = []
      this.removeByType(3)
      this.facturesEquipements.selected.forEach(({ id, code, index_depart, index_fin, montant_equipement, frais_facture, prix_fixe }) => {
        const cout = (index_fin - index_depart) * montant_equipement + frais_facture + prix_fixe
        equipements.push({ code, id, type: this.types[3], montant: cout, aPayer: cout, readonly: false })
      })
      this.ordonnancement.paiements.push(...equipements)
    },
    pushAnnexe() {
      const annexes = []
      this.removeByType(1)
      this.removeByType(2)
      this.removeByType(3)
      const { id, code, montant, sommeVersee } = this.facturesAnnexes.selected
      const reste = Number(montant) - Number(sommeVersee)
      annexes.push({ code, id, type: this.types[4], montant: reste, aPayer: reste, readonly: false })
      this.ordonnancement.paiements.push(...annexes)
    },
    removeByType(type) {
      this.ordonnancement.paiements = this.ordonnancement.paiements.filter((paiement) => paiement.type !== this.types[type])
    },
    async getFactures() {
      this.loading = true
      this.facturesEquipements.selected = []
      const { facturesEquipements, facturesInitiales, facturesLoyers, facturesAnnexes } = await this.getFacturesByContrat(this.ordonnancement.contrat)
      this.facturesEquipements = { selected: [], items: facturesEquipements }
      this.facturesLoyers = { selected: [], items: facturesLoyers }
      this.facturesInitiales = { selected: [], items: facturesInitiales }
      this.facturesAnnexes = { selected: null, items: facturesAnnexes }
      this.ordonnancement.paiements = []
      this.loading = false
    },
  },
}
</script>
