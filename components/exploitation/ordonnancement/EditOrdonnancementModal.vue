<template>
  <b-modal v-model="dialog" size="lg" scrollable>
    <template #modal-header>
      <h5 id="archiver" class="modal-title text-primary">Modifier ordonnancement</h5>
      <button type="button" class="close" aria-label="Close" @click="dialog = false">
        <span aria-hidden="true">
          <feather type="x" />
        </span>
      </button>
    </template>
    <template #default>
      <b-overlay :show="$fetchState.pending || submiting" spinner-variant="primary" rounded="sm">
        <v-app>
          <v-row>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesInitiales.selected"
                :items="facturesInitiales.items"
                item-text="code"
                item-value="id"
                outlined
                return-object
                multiple
                chips
                small-chips
                deletable-chips
                dense
                @change="pushInitiale"
              >
                <template #label>Factures Initiales</template>
                <template #progress>
                  <v-progress-linear indeterminate color="primary" absolute></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesLoyers.selected"
                :items="facturesLoyers.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                multiple
                chips
                small-chips
                deletable-chips
                return-object
                @change="pushLoyer"
              >
                <template #label>Factures de loyer</template>
                <template #progress>
                  <v-progress-linear indeterminate color="primary" absolute></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesEquipements.selected"
                :items="facturesEquipements.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                multiple
                chips
                small-chips
                deletable-chips
                return-object
                @change="pushEquipement"
              >
                <template #label>Factures d'équipement</template>
                <template #progress>
                  <v-progress-linear indeterminate color="primary" absolute></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col cols="3" sm="3">
              <v-autocomplete
                v-model="facturesAnnexes.selected"
                :items="facturesAnnexes.items"
                item-text="code"
                item-value="id"
                outlined
                dense
                return-object
                @change="pushAnnexe"
              >
                <template #label> Factures Annexes </template>
                <template #progress>
                  <v-progress-linear indeterminate color="primary" absolute></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
          </v-row>
          <v-container v-if="!$fetchState.pending">
            <v-simple-table dense>
              <template #default>
                <thead>
                  <tr>
                    <th class="text-left">Code</th>
                    <th class="text-left">Montant total</th>
                    <th class="text-left">Montant à payer</th>
                    <th class="text-right">Reste à payer</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(paiement, index) in ordonnancement.paiements" :key="index">
                    <td>{{ paiement.code }}</td>
                    <td>{{ paiement.aPayer | currency }}</td>
                    <td v-if="paiement.type === types.initiale">
                      <v-text-field v-model.number="paiement.montant" dense></v-text-field>
                    </td>
                    <td v-else>{{ paiement.montant | currency }}</td>
                    <td class="text-right">
                      {{ (Number(paiement.aPayer) - Number(paiement.montant)) | currency }}
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" class="text-right"></td>
                    <td class="text-right">
                      <b>Total:{{ total | currency }}</b>
                    </td>
                  </tr>
                </tfoot>
              </template>
            </v-simple-table>
          </v-container>
        </v-app>
      </b-overlay>
    </template>
    <template #modal-footer>
      <button type="button" class="btn btn-warning" data-dismiss="modal" @click="dialog = false">Fermer</button>
      <button type="button" :disabled="!validable || submiting" class="btn btn-primary text-white" @click="save">Valider</button>
    </template>
  </b-modal>
</template>
<script>
import { mapActions } from 'vuex'
import { FACTURE } from '~/helper/constantes'
import { MODULES } from '~/helper/modules-types'
import modal from '~/mixins/modal'
export default {
  mixins: [modal],
  props: {
    id: {
      type: Number,
      required: true,
    },
  },
  data: () => ({
    ordonnancement: {},
    submiting: false,
    types: FACTURE.type,
    facturesEquipements: { selected: [], items: [] },
    facturesInitiales: { selected: [], items: [] },
    facturesAnnexes: { selected: null, items: [] },
    facturesLoyers: { selected: [], items: [] },
  }),
  async fetch() {
    try {
      const { ordonnancement } = await this.getOrdonnancement(this.id)
      this.ordonnancement = ordonnancement
      await this.getFactures()
    } catch (error) {
      this.$notify({ text: error.response.data.message, type: 'error', title: 'Echec Autorisation' })
    }
  },
  computed: {
    total() {
      let somme = 0
      this.ordonnancement.paiements.forEach(({ montant }) => (somme += Number(montant)))
      return somme
    },
    missingMontant() {
      return this.ordonnancement.paiements.some(({ montant }) => Number(montant) === 0)
    },
    paiementsExist() {
      return this.ordonnancement.paiements.length > 0
    },
    negativePaiement() {
      return this.ordonnancement.paiements.some((paiement) => paiement.aPayer - paiement.montant < 0)
    },
    validable() {
      return this.paiementsExist && !this.missingMontant && !this.negativePaiement
    },
  },
  methods: {
    ...mapActions({
      modifier: MODULES.ORDONNANCEMENT.ACTIONS.EDIT,
      getOrdonnancement: MODULES.ORDONNANCEMENT.ACTIONS.ONE,
      getFacturesByContrat: MODULES.FACTURE.ACTIONS.BY_CONTRAT,
    }),
    save() {
      this.submiting = true
      this.ordonnancement.total = this.total
      this.modifier(this.ordonnancement).then(({ message }) => {
        this.submiting = false
        this.dialog = false
        this.$notify({ text: message, title: "succès de l'opération", type: 'success' })
      })
    },
    pushInitiale() {
      const initiales = []
      this.removeByType(1)
      this.facturesInitiales.selected.forEach(({ id, code, pas_porte: pas, caution, avance, frais_dossier, frais_amenagement, sommeVersee, facture }) => {
        const aPayer = Number(caution) + Number(avance) + Number(pas) + Number(frais_dossier) + Number(frais_amenagement)
        initiales.push({
          code,
          id,
          type: facture.type,
          montant: 0,
          aPayer: Number(aPayer) - Number(sommeVersee),
        })
      })
      this.ordonnancement.paiements.push(...initiales)
      console.log(this.ordonnancement)
    },
    pushLoyer() {
      const loyers = []
      this.removeByType(2)
      this.facturesLoyers.selected.forEach(({ id, code, loyer, facture }) => {
        loyers.push({ code, id, type: facture.type, montant: loyer, aPayer: loyer })
      })
      this.ordonnancement.paiements.push(...loyers)
    },
    pushEquipement() {
      const equipements = []
      this.facturesEquipements.selected.forEach(({ id, code, index_depart, index_fin, equipement, facture }) => {
        const cout = (index_fin - index_depart) * equipement.prix_fixe
        equipements.push({ code, id, type: facture.type, montant: cout, aPayer: cout })
      })
      this.ordonnancement.paiements.push(...equipements)
    },
    pushAnnexe() {
      const annexes = []
      this.removeByType(1)
      this.removeByType(2)
      this.removeByType(3)
      const { id, code, montant, facture } = this.facturesAnnexes.selected
      annexes.push({ code, id, type: facture.type, montant, aPayer: montant })
      this.ordonnancement.paiements.push(...annexes)
    },
    removeByType(type) {
      this.ordonnancement.paiements = this.ordonnancement.paiements.filter((paiement) => paiement.type !== this.types[type])
    },
    async getFactures() {
      const { facturesEquipements, facturesInitiales, facturesLoyers, facturesAnnexes } = await this.getFacturesByContrat(this.ordonnancement.contrat.id)
      this.facturesEquipements.selected = []
      this.facturesEquipements = { selected: [], items: facturesEquipements }
      this.facturesLoyers = { selected: [], items: facturesLoyers }
      this.facturesInitiales = { selected: [], items: facturesInitiales }
      this.facturesAnnexes = { selected: null, items: facturesAnnexes }
      this.initialisation()
    },
    initialisation() {
      const loyers = this.ordonnancement.paiements.map(({ facture_id }) => facture_id)
      const equipements = this.ordonnancement.paiements.map(({ facture_id }) => facture_id)
      const initiales = this.ordonnancement.paiements.map(({ facture_id }) => facture_id)
      this.facturesInitiales.selected = this.facturesInitiales.items.filter((facture) => initiales.includes(facture.id))
      this.facturesLoyers.selected = this.facturesLoyers.items.filter((facture) => loyers.includes(facture.id))
      this.facturesEquipements.selected = this.facturesEquipements.items.filter((facture) => equipements.includes(facture.id))
      this.pushInitiale()
      this.pushLoyer()
      this.pushEquipement()
      this.pushAnnexe()
    },
  },
}
</script>
