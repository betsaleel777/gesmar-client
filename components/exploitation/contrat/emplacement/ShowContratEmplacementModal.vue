<template>
  <b-modal v-model="dialog" scrollable size="lg" hide-footer>
    <div v-if="!contrat" class="text-center">
      <b-spinner variant="primary" label="Text Centered"></b-spinner>
    </div>
    <template v-if="contrat" #modal-header>
      <h5 class="modal-title text-primary">Détails du contrat {{ contrat.code }}</h5>
      <button type="button" class="close" aria-label="Close" @click="dialog = false">
        <span aria-hidden="true"><feather type="x" /></span>
      </button>
    </template>
    <template v-if="contrat" #default>
      <div class="card card-invoice">
        <div class="card-header">
          <div>
            <h5 class="mg-b-3">Contrat {{ contrat.code }}</h5>
            <span class="tx-sm text-muted">fait le: {{ $moment(contrat.created_at).format('ll') }}</span>
          </div>
          <div class="btn-group-invoice">
            <button class="btn btn-white btn-sm btn-uppercase" @click="imprimer">
              <feather type="printer" size="20" stroke="blue" />
            </button>
            <button class="btn btn-white btn-sm btn-uppercase">
              <feather type="mail" size="20" stroke="blue" />
            </button>
            <button v-if="validable" class="btn btn-brand-02 btn-sm btn-uppercase" @click="valider">
              <feather type="check-circle" size="20" stroke="white" />
            </button>
          </div>
        </div>
        <!-- card-header -->
        <div class="card-body">
          <div class="row">
            <div class="col-sm-4 col-lg-4">
              <!-- <label class="content-label">Billed From</label> -->
              <h6 class="tx-15 mg-b-10">{{ contrat.site.nom }}</h6>
              <p class="mg-b-0">{{ contrat.site.adresse }}</p>
              <p class="mg-b-0">Tel No: {{ contrat.site.contact }}</p>
              <p class="mg-b-0">Email: {{ contrat.site.email }}</p>
            </div>
            <div class="col-sm-4 col-lg-4">
              <!-- <label class="content-label">facturé à</label> -->
              <h6 class="tx-15 mg-b-10">{{ contrat.personne.alias }}</h6>
              <p class="mg-b-0">{{ contrat.personne.ville }}</p>
              <p class="mg-b-0">{{ contrat.personne.contact }}</p>
              <p v-if="contrat.personne.email" class="mg-b-0">
                {{ contrat.personne.email }}
              </p>
            </div>
            <!-- col -->
            <div class="col-sm-4 col-lg-4">
              <ul class="list-unstyled lh-7">
                <li class="d-flex justify-content-between">
                  <h6 class="tx-15 mg-b-10">
                    <span>Code du contrat: </span>
                    <span>{{ contrat.code }}</span>
                  </h6>
                </li>
                <li class="d-flex justify-content-between">
                  <span>Début: </span>
                  <span>{{ $moment(contrat.debut).format('DD-MM-YYYY') }} </span>
                </li>
                <li class="d-flex justify-content-between">
                  <span>Fin: </span>
                  <span>{{ $moment(contrat.debut).add(1, 'Y').format('DD-MM-YYYY') }}</span>
                </li>
              </ul>
            </div>
            <!-- col -->
          </div>
          <!-- row -->
          <h5 class="mg-t-25">Emplacement</h5>
          <div class="table-responsive">
            <table class="table table-invoice bd-b">
              <thead>
                <tr>
                  <th class="wd-20p">Code emplacement</th>
                  <th class="tx-center">Type</th>
                  <th class="tx-center">Caution</th>
                  <th class="tx-center">Avance</th>
                  <th class="tx-right">Loyer</th>
                  <th class="tx-right">Pas de porte</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="tx-nowrap">{{ contrat.emplacement.code }}</td>
                  <td class="tx-center">
                    {{ contrat.emplacement.type.nom }}
                  </td>
                  <td class="tx-center">{{ contrat.emplacement.caution }} mois</td>
                  <td class="tx-center">{{ contrat.avance }} mois</td>
                  <td class="tx-right">{{ contrat.emplacement.loyer | currency }}</td>
                  <td class="tx-right">{{ contrat.emplacement.pas_porte | currency }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div v-if="contrat.equipements.length > 0">
            <h5 class="mg-t-25">Equipements</h5>
            <div class="table-responsive">
              <table class="table table-invoice bd-b">
                <thead>
                  <tr>
                    <th class="wd-20p">Type</th>
                    <th class="tx-center">Caution</th>
                    <th class="tx-center">Equipement</th>
                    <th class="tx-center">...</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(type, index) in contrat.equipements" :key="index">
                    <td class="tx-nowrap">{{ type.nom }}</td>
                    <td class="tx-center">{{ type.caution_abonnement | currency }}</td>
                    <td v-if="typeAbonnement[type.id]" class="tx-center">
                      {{ typeAbonnement[type.id][0] }}
                    </td>
                    <td v-else class="tx-center">Aucun</td>
                    <td class="tx-center">
                      <v-btn
                        :disabled="type.pivot.abonnable === 0"
                        class="ma-2"
                        text
                        icon
                        small
                        @click="selectionner(type)"
                      >
                        <v-icon>mdi-plus</v-icon>
                      </v-btn>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="row justify-content-between mg-t-25">
            <div class="col-sm-6 col-lg-6 order-2 order-sm-0 mg-t-40 mg-sm-t-0">
              <!-- <label class="content-label mg-b-10">Notez bien</label>
              <p class="tx-sm">
                Sed ut perspiciatis unde omnis iste natus error sit voluptatem
                accusantium doloremque laudantium, totam rem aperiam, eaque ipsa
                quae ab illo inventore veritatis et quasi architecto beatae
                vitae dicta sunt explicabo.
              </p> -->
            </div>
            <!-- col -->
            <div class="col-sm-6 col-lg-4 order-1 order-sm-0">
              <ul class="list-unstyled lh-7 pd-r-10">
                <li class="d-flex justify-content-between text-muted">
                  <span>Caution</span>
                  <span>{{ caution | currency }}</span>
                </li>
                <li class="d-flex justify-content-between text-muted">
                  <span>Pas de porte</span>
                  <span>{{ contrat.emplacement.pas_porte | currency }}</span>
                </li>
                <hr class="mg-y-0" />
                <li class="d-flex justify-content-between">
                  <span>Emplacement</span>
                  <span>{{ subtotalBail | currency }}</span>
                </li>
                <li class="d-flex justify-content-between">
                  <span>Equipements</span>
                  <span>{{ subtotalGears | currency }}</span>
                </li>
                <li class="d-flex justify-content-between">
                  <span>Timbre</span>
                  <span>{{ 100 | currency }}</span>
                </li>
                <li class="d-flex justify-content-between">
                  <strong>Total</strong>
                  <strong>{{ total | currency }}</strong>
                </li>
              </ul>
              <button v-if="validable" class="btn btn-block btn-primary btn-brand-02" @click="valider">
                valider
              </button>
            </div>
            <!-- col -->
          </div>
        </div>
        <!-- card-body -->
        <SelectEquipementModal
          v-if="select.modal"
          v-model="select.modal"
          :infos="select.infos"
          @selected="onSelected"
        />
      </div>
    </template>
  </b-modal>
</template>

<script>
import { mapActions } from 'vuex'
import SelectEquipementModal from './SelectEquipementModal.vue'
import { CONTRAT, ABONNEMENT } from '~/helper/constantes'
import { downloadPdf } from '~/helper/helpers'
const ABONNEMENT_STATUS = ABONNEMENT
export default {
  components: { SelectEquipementModal },
  props: {
    id: { type: Number, required: true },
    value: Boolean,
  },
  data: () => ({
    contrat: null,
    STATUS: CONTRAT.status,
    typeAbonnement: {},
    select: {
      infos: {},
      modal: false,
    },
  }),
  computed: {
    dialog: {
      get() {
        return this.value
      },
      set(value) {
        this.$emit('input', value)
      },
    },
    indexErrorFound() {
      let found = false
      for (const key in this.typeAbonnement) {
        if (this.typeAbonnement[key][0] === ABONNEMENT_STATUS.error) {
          found = true
          break
        }
      }
      return found
    },
    canValid() {
      const abonnable = this.contrat.equipements.some(
        ({ pivot: { abonnable } }) => Boolean(abonnable) === true
      )
      return !abonnable
    },
    validable() {
      return this.contrat.status === this.STATUS.attente && this.canValid && !this.indexErrorFound
    },
    caution() {
      return (this.contrat.emplacement.caution + this.contrat.avance) * this.contrat.emplacement.loyer
    },
    subtotalBail() {
      return this.caution + this.contrat.emplacement.pas_porte
    },
    subtotalGears() {
      let total = 0
      this.contrat.equipements.forEach((type) => {
        total += Number(type.caution_abonnement)
      })
      return total
    },
    dossierComplet() {
      return this.contrat.personne.complet
    },
    total() {
      return this.subtotalBail + this.subtotalGears + 100
    },
  },
  created() {
    this.initialisation()
  },
  methods: {
    ...mapActions({
      getValider: 'exploitation/contrat-emplacement/schedule',
      getDetails: 'exploitation/contrat-emplacement/getDetails',
      getPrint: 'exploitation/contrat-emplacement/print',
    }),
    valider() {
      this.getValider(this.contrat.id).then(({ message }) => {
        this.$root.$bvToast.toast(message, {
          title: 'succès de la validation'.toLocaleUpperCase(),
          variant: 'success',
          solid: true,
        })
        this.dialog = false
      })
    },
    selectionner({ id, nom }) {
      this.select.infos = {
        typeId: id,
        nom,
        emplacement_id: this.contrat.emplacement_id,
        site_id: this.contrat.site_id,
        contrat_id: this.contrat.id,
      }
      this.select.modal = true
    },
    onSelected() {
      this.initialisation()
    },
    initialisation() {
      this.getDetails(this.id).then(({ contrat }) => {
        this.contrat = contrat
        this.contrat.emplacement.abonnements.forEach(
          ({ status, equipement: { type_equipement_id: type, code } }) => {
            ABONNEMENT_STATUS.error === status
              ? (this.typeAbonnement[type] = [status])
              : (this.typeAbonnement[type] = [code])
          }
        )
      })
    },
    imprimer() {
      if (this.completudeDossier()) {
        this.getPrint(this.id).then(({ message, path }) => {
          if (message) {
            this.$root.$bvToast.toast(message, {
              title: "echec de l'opération".toLocaleUpperCase(),
              variant: 'danger',
              solid: true,
            })
          }
          if (path) {
            downloadPdf(path)
          }
        })
      }
    },
    completudeDossier() {
      if (!this.dossierComplet) {
        this.$root.$bvToast.toast('Le contrat ne peut pas être imprimé car le dossier du client incomplet.', {
          title: "echec de l'opération".toLocaleUpperCase(),
          variant: 'danger',
          solid: true,
        })
      }
      return this.dossierComplet
    },
  },
}
</script>

<style></style>
