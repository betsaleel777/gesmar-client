<template>
  <b-modal v-model="dialog">
    <template #modal-header>
      <h5 class="modal-title text-primary">Apport initiale</h5>
      <button type="button" class="close" aria-label="Close" @click="dialog = false">
        <span aria-hidden="true"><feather type="x" /></span>
      </button>
    </template>
    <template #default>
      <b-overlay :show="submiting" spinner-variant="primary" rounded="sm">
        <v-app>
          <v-form ref="form" class="mt-5">
            <v-text-field
              v-model.number="contrat.apport_initial"
              label="Apport initial"
              suffix="FCFA"
              dense
              :error="errors.apport_initial.exist"
              :error-messages="errors.apport_initial.message"
            ></v-text-field>
          </v-form>
          <v-alert v-if="message" dense prominent text type="warning">{{ message }}</v-alert>
        </v-app>
      </b-overlay>
    </template>
    <template #modal-footer>
      <button type="button" class="btn btn-warning" data-dismiss="modal" @click="dialog = false">Fermer</button>
      <button type="button" :disabled="submiting" class="btn btn-primary text-white" @click="save">Valider</button>
    </template>
  </b-modal>
</template>
<script>
import { mapActions } from 'vuex'
import { errorHandling } from '~/helper/helpers'
import { MODULES } from '~/helper/modules-types'
import modal from '~/mixins/modal'
export default {
  mixins: [modal],
  props: {
    id: {
      type: Number,
      required: true,
    },
  },
  emits: ['submited'],
  data: () => ({
    submiting: false,
    contrat: {
      apport_initial: null,
      id: null,
    },
    message: null,
    errors: {
      apport_initial: { exist: false, message: null },
    },
  }),
  watch: {
    'contrat.apport_initial'(value) {
      if (value === 0 && !this.errors.apport_initial.exist)
        this.message = "êtes vous certains ? car cela implique qu'il n'y aura aucun paiement à la caisse pour cette demande."
      else this.message = null
    },
  },
  methods: {
    ...mapActions({ validate: MODULES.CONTRAT.BAIL.ACTIONS.VALIDATE }),
    save() {
      this.submiting = true
      this.contrat.id = this.id
      this.validate(this.contrat)
        .then(({ message }) => {
          this.$notify({ text: message, title: "succès de l'opération", type: 'success' })
          this.$emit('submited')
          this.dialog = false
        })
        .catch((err) => {
          errorHandling(err.response, this.errors)
        })
        .finally(() => (this.submiting = false))
    },
  },
}
</script>
<style scoped></style>
