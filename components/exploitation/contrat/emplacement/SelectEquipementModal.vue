<template>
  <b-modal id="modalSelectEquipement" v-model="dialog">
    <template #modal-header>
      <h5 class="modal-title text-primary">Abonnement {{ infos.nom }}</h5>
      <button type="button" class="close" aria-label="Close" @click="dialog = false">
        <span aria-hidden="true"><feather type="x" /></span>
      </button>
    </template>
    <template #default>
      <v-app>
        <v-autocomplete
          v-model="abonnement.equipement_id"
          :items="equipements"
          item-text="code"
          item-value="id"
          outlined
          dense
          :error="errors.equipement_id.exist"
          :error-messages="errors.equipement_id.message"
          :loading="loading"
          @change="getIndex"
        >
          <template #label>
            Choix d'équipement
            <span class="red--text"><strong>* </strong></span>
          </template>
          <template #progress>
            <v-progress-linear v-if="loading" indeterminate color="primary" absolute></v-progress-linear>
          </template>
        </v-autocomplete>
        <v-row>
          <v-col cols="6">
            <v-text-field
              v-model="abonnement.index_depart"
              dense
              readonly
              :error="errors.index_depart.exist"
              :error-messages="errors.index_depart.message"
            >
              <template #label>Index de départ</template>
            </v-text-field>
          </v-col>
          <v-col cols="6">
            <v-text-field
              v-model="abonnement.index_autre"
              dense
              :error="errors.index_autre.exist"
              :error-messages="errors.index_autre.message"
            >
              <template #label>
                Index Actuel
                <span class="red--text"><strong>* </strong></span>
              </template>
            </v-text-field>
          </v-col>
        </v-row>
      </v-app>
    </template>
    <template #modal-footer>
      <button type="button" class="btn btn-warning" @click="dialog = false">Fermer</button>
      <button type="button" class="btn btn-primary" @click="save">Abonner</button>
    </template>
  </b-modal>
</template>

<script>
import { mapActions } from 'vuex'
import { errorsWriting, errorsInitialise } from '~/helper/handleErrors'
export default {
  props: {
    infos: {
      type: Object,
      required: true,
    },
    value: Boolean,
  },
  emits: ['selected'],
  data: () => ({
    equipements: [],
    loading: false,
    abonnement: {
      equipement_id: null,
      emplacement_id: null,
      index_depart: null,
      index_autre: null,
      contrat_id: null,
    },
    errors: {
      index_depart: { exist: false, message: null },
      index_autre: { exist: false, message: null },
      equipement_id: { exist: false, message: null },
    },
  }),
  computed: {
    dialog: {
      get() {
        return this.value
      },
      set(value) {
        this.$emit('input', value)
      },
    },
  },
  mounted() {
    this.loading = true
    this.abonnement.emplacement_id = this.infos.emplacement_id
    this.abonnement.contrat_id = this.infos.contrat_id
    this.getByType(this.infos).then(({ equipements }) => {
      // trouver l'equipement lié à l'emplacement dont le type a été proposé
      const found = equipements.find((equipement) => equipement.emplacement_id === this.infos.emplacement_id)
      if (found) {
        // préselection de l'equipement lié à l'emplacement dont le type a été proposé
        this.equipements.push(found)
        this.abonnement.equipement_id = found.id
        this.getIndex()
      } else {
        this.equipements = equipements
      }
      this.loading = false
    })
  },
  methods: {
    ...mapActions('architecture/abonnement', ['abonner', 'getLastIndex']),
    ...mapActions('architecture/equipement', ['getByType']),
    save() {
      this.abonner(this.abonnement)
        .then(({ message }) => {
          this.$root.$bvToast.toast(message, {
            title: 'succès de la validation'.toLocaleUpperCase(),
            variant: 'success',
            solid: true,
          })
          this.$emit('selected')
          this.dialog = false
        })
        .catch((err) => {
          const { data } = err.response
          if (data) {
            errorsInitialise(this.errors)
            errorsWriting(data.errors, this.errors)
          }
        })
    },
    getIndex() {
      if (this.abonnement.equipement_id) {
        this.getLastIndex(this.abonnement.equipement_id).then(({ index }) => {
          this.abonnement.index_depart = index
        })
      }
    },
  },
}
</script>

<style></style>
