<template>
  <b-modal v-model="dialog">
    <template #modal-header>
      <h5 class="modal-title text-primary">Abonnement {{ infos.nom }}</h5>
      <button type="button" class="close" aria-label="Close" @click="dialog = false">
        <span aria-hidden="true"><feather type="x" /></span>
      </button>
    </template>
    <template #default>
      <v-app>
        <v-autocomplete
          v-model="abonnement.equipement_id"
          :items="equipements"
          item-text="code"
          item-value="id"
          outlined
          dense
          :error="errors.equipement_id.exist"
          :error-messages="errors.equipement_id.message"
          :loading="$fetchState.pending"
          @change="getIndex"
        >
          <template #label>
            Choix d'équipement
            <span class="red--text"><strong>* </strong></span>
          </template>
          <template #progress>
            <v-progress-linear
              v-if="$fetchState.pending"
              indeterminate
              color="primary"
              absolute
            ></v-progress-linear>
          </template>
        </v-autocomplete>
        <v-row>
          <v-col cols="6">
            <v-text-field
              v-model="abonnement.index_depart"
              dense
              readonly
              :error="errors.index_depart.exist"
              :error-messages="errors.index_depart.message"
            >
              <template #label>Index de départ</template>
            </v-text-field>
          </v-col>
          <v-col cols="6">
            <v-text-field
              v-model="abonnement.index_autre"
              dense
              :error="errors.index_autre.exist"
              :error-messages="errors.index_autre.message"
            >
              <template #label>
                Index Actuel
                <span class="red--text"><strong>* </strong></span>
              </template>
            </v-text-field>
          </v-col>
        </v-row>
      </v-app>
    </template>
    <template #modal-footer>
      <button type="button" class="btn btn-warning" @click="dialog = false">Fermer</button>
      <button type="button" :disabled="submiting" class="btn btn-primary" @click="save">Abonner</button>
    </template>
  </b-modal>
</template>

<script>
import { mapActions } from 'vuex'
import { errorHandling } from '~/helper/helpers'
import { MODULES } from '~/helper/modules-types'
import modal from '~/mixins/modal'
export default {
  mixins: [modal],
  props: {
    infos: {
      type: Object,
      required: true,
    },
  },
  emits: ['selected'],
  data: () => ({
    submiting: false,
    equipements: [],
    abonnement: {
      equipement_id: null,
      emplacement_id: null,
      index_depart: null,
      index_autre: null,
      contrat_id: null,
    },
    errors: {
      index_depart: { exist: false, message: null },
      index_autre: { exist: false, message: null },
      equipement_id: { exist: false, message: null },
    },
  }),
  async fetch() {
    this.abonnement.emplacement_id = this.infos.emplacement_id
    this.abonnement.contrat_id = this.infos.contrat_id
    const { equipements } = await this.getByType(this.infos)
    // trouver l'equipement lié à l'emplacement dont le type a été proposé
    const found = equipements.find((equipement) => equipement.emplacement_id === this.infos.emplacement_id)
    if (found) {
      // préselection de l'equipement lié à l'emplacement dont le type a été proposé
      this.equipements.push(found)
      this.abonnement.equipement_id = found.id
      this.getIndex()
    } else {
      this.equipements = equipements
    }
  },
  methods: {
    ...mapActions({
      abonner: MODULES.ABONNEMENT.ACTIONS.SUBSCRIBE,
      getLastIndex: MODULES.ABONNEMENT.ACTIONS.LAST_INDEX,
      getByType: MODULES.EQUIPEMENT.ACTIONS.BY_TYPE,
    }),
    save() {
      this.submiting = true
      this.abonner(this.abonnement)
        .then(({ message }) => {
          this.$notify({ text: message, title: "succès de l'opération", type: 'success' })
          this.$emit('selected')
          this.dialog = false
        })
        .catch((err) => {
          errorHandling(err.response, this.errors)
        })
        .finally(() => (this.submiting = false))
    },
    getIndex() {
      if (this.abonnement.equipement_id) {
        this.getLastIndex(this.abonnement.equipement_id).then(({ index }) => {
          this.abonnement.index_depart = index
        })
      }
    },
  },
}
</script>

<style></style>
