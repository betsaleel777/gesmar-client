<template>
  <b-modal v-model="dialog">
    <template #modal-header>
      <h5 class="modal-title text-primary">Signer le contrat</h5>
      <button type="button" class="close" aria-label="Close" @click="dialog = false">
        <span aria-hidden="true"><feather type="x" /></span>
      </button>
    </template>
    <template #default>
      <b-overlay :show="submiting" spinner-variant="primary" rounded="sm">
        <v-app>
          <v-file-input
            v-model="contrat.attachment"
            show-size
            dense
            outlined
            truncate-length="20"
            class="mt-2"
            :error="errors.attachment.exist"
            :error-messages="errors.attachment.message"
          >
            <template #label>
              Fichier du contrat signé
              <span class="red--text"><strong>* </strong></span>
            </template>
          </v-file-input>
          <v-dialog ref="dialog" v-model="modal" :return-value.sync="contrat.date_signature" :retain-focus="false" persistent width="290px">
            <template #activator="{ on, attrs }">
              <v-text-field
                v-model="contrat.date_signature"
                outlined
                dense
                prepend-icon="mdi-calendar"
                readonly
                :error="errors.date_signature.exist"
                :error-messages="errors.date_signature.message"
                v-bind="attrs"
                v-on="on"
              >
                <template #label>
                  Date de signature
                  <span class="red--text"><strong>* </strong></span>
                </template>
              </v-text-field>
            </template>
            <v-date-picker v-model="contrat.date_signature" locale="fr" scrollable>
              <v-spacer></v-spacer>
              <v-btn text color="primary" @click="modal = false"> Fermer </v-btn>
              <v-btn text color="primary" @click="$refs.dialog.save(contrat.date_signature)"> OK </v-btn>
            </v-date-picker>
          </v-dialog>
        </v-app>
      </b-overlay>
    </template>
    <template #modal-footer>
      <button type="button" class="btn btn-warning" data-dismiss="modal" @click="dialog = false">Fermer</button>
      <button type="button" :disabled="submiting" class="btn btn-primary text-white" @click="save">Valider</button>
    </template>
  </b-modal>
</template>

<script>
import { mapActions } from 'vuex'
import { MODULES } from '~/helper/modules-types'
import { errorHandling } from '~/helper/helpers'
import modal from '~/mixins/modal'
export default {
  mixins: [modal],
  props: {
    id: {
      type: Number,
      required: true,
    },
  },
  emits: ['submited'],
  data() {
    return {
      modal: false,
      contrat: {
        id: this.id,
        attachment: null,
        date_signature: '',
      },
      submiting: false,
      errors: {
        attachment: { exist: false, message: null },
        date_signature: { exist: false, message: null },
      },
    }
  },
  methods: {
    ...mapActions({ signer: MODULES.CONTRAT.BAIL.ACTIONS.SIGNER }),
    save() {
      this.signer(this.contrat)
        .then(({ message }) => {
          this.$notify({ text: message, title: "succès de l'opération", type: 'success' })
          this.$emit('submited')
          this.dialog = false
        })
        .catch((err) => {
          errorHandling(err.response, this.errors)
        })
        .finally(() => (this.submiting = false))
    },
  },
}
</script>
