<template>
  <b-modal v-model="dialog" size="xl" no-close-on-backdrop>
    <template #modal-header>
      <h5 id="archiver" class="modal-title text-primary">Création De Demande Pour Emplacements</h5>
      <button type="button" class="close" aria-label="Close" @click="dialog = false">
        <span aria-hidden="true"><feather type="x" /></span>
      </button>
    </template>
    <template #default>
      <b-overlay :show="$fetchState.pending || submiting" spinner-variant="primary" rounded="sm">
        <v-app>
          <v-row>
            <v-col>
              <v-radio-group v-model="mode" row dense>
                <v-radio label="prospect" :value="0"></v-radio>
                <v-radio label="Ancien client ou prospect" :value="1"></v-radio>
              </v-radio-group>
            </v-col>
          </v-row>
        </v-app>
        <div v-if="mode === 0">
          <div class="row">
            <div class="col-md-6 col-sm-6">
              <div class="form-group">
                <label class="form-label">Nom<span class="text-danger">*</span></label>
                <input
                  v-model="contrat.prospect.nom"
                  type="text"
                  class="form-control"
                  :class="{ 'is-invalid': errors.nom.exist }"
                  placeholder="Entrer le nom"
                />
                <span v-if="errors.nom.exist" class="invalid-feedback" role="alert">
                  <strong>{{ errors.nom.message }}</strong>
                </span>
              </div>
              <div class="form-group">
                <label class="form-label">Adresse<span class="text-danger">*</span></label>
                <input
                  v-model="contrat.prospect.adresse"
                  type="text"
                  class="form-control"
                  :class="{ 'is-invalid': errors.adresse.exist }"
                  placeholder="Entrer l'adresse"
                />
                <span v-if="errors.adresse.exist" class="invalid-feedback" role="alert">
                  <strong>{{ errors.adresse.message }}</strong>
                </span>
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input v-model="contrat.prospect.email" type="text" class="form-control" placeholder="Entrer le courriel" />
              </div>
            </div>
            <div class="col-md-6 col-sm-6">
              <div class="form-group">
                <label class="form-label">Prenom<span class="text-danger">*</span></label>
                <input
                  v-model="contrat.prospect.prenom"
                  type="text"
                  class="form-control"
                  :class="{ 'is-invalid': errors.prenom.exist }"
                  placeholder="Entrer le prenom"
                />
                <span v-if="errors.prenom.exist" class="invalid-feedback" role="alert">
                  <strong>{{ errors.prenom.message }}</strong>
                </span>
              </div>
              <div class="form-group">
                <label class="form-label">contact<span class="text-danger">*</span></label>
                <input
                  v-model="contrat.prospect.contact"
                  type="text"
                  class="form-control"
                  :class="{ 'is-invalid': errors.contact.exist }"
                  placeholder="Entrer le contact"
                />
                <span v-if="errors.contact.exist" class="invalid-feedback" role="alert">
                  <strong>{{ errors.contact.message }}</strong>
                </span>
              </div>
              <div class="form-group">
                <label class="form-label">Ville<span class="text-danger">*</span></label>
                <input
                  v-model="contrat.prospect.ville"
                  type="text"
                  class="form-control"
                  :class="{ 'is-invalid': errors.ville.exist }"
                  placeholder="Entrer la ville"
                />
                <span v-if="errors.ville.exist" class="invalid-feedback" role="alert">
                  <strong>{{ errors.ville.message }}</strong>
                </span>
              </div>
            </div>
          </div>
        </div>
        <div v-else>
          <v-app>
            <v-autocomplete
              v-model="contrat.personne_id"
              :items="personnes"
              item-text="alias"
              item-value="id"
              outlined
              dense
              :error="errors.personne_id.exist"
              :error-messages="errors.personne_id.message"
              @change="getDemandes"
            >
              <template #label>
                Sélection du demandeur
                <span class="red--text"><strong>* </strong></span>
              </template>
            </v-autocomplete>
          </v-app>
        </div>
        <v-app>
          <v-row>
            <v-col>
              <v-autocomplete v-model="contrat.site_id" :items="sites" item-text="nom" item-value="id" outlined dense @change="getEmplacementByMarket">
                <template #label>
                  Choix du marché
                  <span class="red--text"><strong>* </strong></span>
                </template>
              </v-autocomplete>
            </v-col>
            <v-col>
              <v-autocomplete
                v-model="selected"
                :items="emplacements"
                item-text="code"
                item-value="id"
                return-object
                outlined
                dense
                multiple
                chips
                small-chips
                deletable-chips
                color="indigo"
                item-color="indigo"
                :disabled="!enableEmplacementList"
                :loading="loading"
                @change="changeItem"
              >
                <template #label>
                  Sélection de l'emplacement
                  <span class="red--text"><strong>* </strong></span>
                </template>
                <template #progress>
                  <v-progress-linear v-if="loading" indeterminate color="indigo" absolute></v-progress-linear>
                </template>
              </v-autocomplete>
            </v-col>
          </v-row>
          <v-simple-table v-if="contrat.infos.length > 0" dense>
            <template #default>
              <thead>
                <tr>
                  <th class="text-left" style="width: 1%">N</th>
                  <th class="text-center">...</th>
                  <th class="text-left" style="width: 15%">Code emplacement</th>
                  <th class="text-left" style="width: 11%">debut</th>
                  <th class="text-left" style="width: 11%">fin</th>
                  <th class="text-left" style="width: 10%">avance (mois)</th>
                  <th class="text-left">Equipements</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(info, index) in contrat.infos" :key="index">
                  <td>
                    <b>{{ index + 1 }}</b>
                  </td>
                  <td class="text-center">
                    <v-tooltip left color="indigo">
                      <template #activator="{ on, attrs }">
                        <v-btn icon v-bind="attrs" v-on="on">
                          <v-icon> mdi-information </v-icon>
                        </v-btn>
                      </template>
                      <span>
                        <b>Superficie: </b>{{ info.superficie }}m²<br />
                        <b>Loyer: </b>{{ info.loyer }} FCFA<br />
                        <b>Pas de porte: </b>{{ info.pas || 0 }} FCFA<br />
                        <b>Caution: </b>{{ info.caution }} mois = {{ info.caution }} FCFA
                      </span>
                    </v-tooltip>
                  </td>
                  <td>{{ info.code }}</td>
                  <td>
                    <v-text-field v-model="info.debut" type="date" dense></v-text-field>
                  </td>
                  <td>
                    <v-text-field
                      :value="info.debut ? (info.fin = $moment(info.debut).add(1, 'Y').format('DD-MM-YYYY')) : null"
                      dense
                      type="text"
                      readonly
                    ></v-text-field>
                  </td>
                  <td>
                    <v-text-field v-model="info.avance" dense></v-text-field>
                  </td>
                  <td>
                    <v-switch v-if="!info.equipable" v-model="info.equipable" dense :label="!info.equipable ? 'avec équipement' : null"></v-switch>
                    <v-autocomplete
                      v-else
                      v-model="info.types"
                      :items="types"
                      item-text="nom"
                      item-value="id"
                      dense
                      single-line
                      multiple
                      chips
                      small-chips
                      deletable-chips
                      color="indigo"
                      item-color="indigo"
                    >
                      <template #label>
                        Type d'equipement
                        <span class="red--text"><strong>* </strong></span>
                      </template>
                    </v-autocomplete>
                  </td>
                </tr>
              </tbody>
            </template>
          </v-simple-table>
        </v-app>
      </b-overlay>
    </template>
    <template #modal-footer>
      <button type="button" class="btn btn-warning" data-dismiss="modal" @click="dialog = false">Fermer</button>
      <button type="button" :disabled="submiting" class="btn btn-primary text-white" @click="save">Valider</button>
    </template>
  </b-modal>
</template>
<script>
import { mapActions, mapGetters } from 'vuex'
import { errorHandling } from '~/helper/helpers'
import { MODULES } from '~/helper/modules-types'
import modal from '~/mixins/modal'
export default {
  mixins: [modal],
  data: () => ({
    loading: false,
    mode: 0,
    selected: [],
    emplacements: [],
    onceGear: false,
    submiting: false,
    contrat: {
      prospect: {
        nom: '',
        prenom: '',
        adresse: '',
        email: '',
        contact: '',
        ville: '',
      },
      infos: [],
      site_id: null,
      personne_id: null,
    },
    errors: {
      nom: { exist: false, message: null },
      prenom: { exist: false, message: null },
      adresse: { exist: false, message: null },
      email: { exist: false, message: null },
      contact: { exist: false, message: null },
      ville: { exist: false, message: null },
      personne_id: { exist: false, message: null },
    },
  }),
  async fetch() {
    try {
      await this.getSites()
    } catch (error) {
      this.$notify({ text: error.response.data.message, type: 'error', title: 'Echec Autorisation' })
    }
    try {
      await this.getPersonnes()
    } catch (error) {
      this.$notify({ text: error.response.data.message, type: 'error', title: 'Echec Autorisation' })
    }
  },
  computed: {
    ...mapGetters({
      types: MODULES.TYPE.EQUIPEMENT.GETTERS.TYPES,
      sites: MODULES.SITE.GETTERS.SITES,
      personnes: MODULES.PERSONNE.GETTERS.PERSONNES,
    }),
    enableEmplacementList() {
      return this.mode ? Boolean(this.contrat.site_id) && Boolean(this.contrat.personne_id) : true
    },
  },
  methods: {
    ...mapActions({
      ajouter: MODULES.CONTRAT.BAIL.ACTIONS.ADD,
      getPersonnes: MODULES.PERSONNE.ACTIONS.FOR_SELECT,
      getSites: MODULES.SITE.ACTIONS.ALL,
      getByPersonne: MODULES.CONTRAT.BAIL.ACTIONS.BY_PERSONNE,
      getEmplacements: MODULES.EMPLACEMENT.ACTIONS.FREE_BY_MARCHE_PERSONNE,
      getTypes: MODULES.TYPE.EQUIPEMENT.ACTIONS.ALL,
    }),
    save() {
      if (this.validate()) {
        this.submiting = true
        this.ajouter({ ...this.contrat, mode: this.mode })
          .then(({ message }) => {
            this.dialog = false
            this.$notify({ text: message, title: "succès de l'opération", type: 'success' })
          })
          .catch((err) => {
            errorHandling(err.response, this.errors)
          })
          .finally(() => (this.submiting = false))
      } else {
        this.$notify({
          text: "Aucun emplacement selectioné ou le formulaire pour emplacements n'est pas correctement rempli",
          title: "succès de l'opération",
          type: 'error',
        })
      }
    },
    validate() {
      let condition = true
      this.contrat.infos.forEach((info) => {
        if (info.equipable) condition = Boolean(info.debut && info.avance && info.types.length > 0)
        else condition = Boolean(info.debut && info.avance)
      })
      return this.contrat.infos.length > 0 && condition
    },
    changeItem() {
      if (!this.onceGear) {
        this.onceGear = true
        this.getTypes()
      }
      this.contrat.infos = []
      this.selected.forEach(({ id, code, loyer, superficie, pas_porte: pas, caution }) => {
        this.contrat.infos.push({
          emplacement_id: id,
          code,
          loyer,
          superficie,
          pas: Number(pas),
          caution: Number(caution),
          fin: null,
          debut: null,
          avance: null,
          types: [],
          equipable: false,
        })
      })
    },
    getEmplacementByMarket() {
      this.loading = true
      this.getEmplacements({ marche: this.contrat.site_id, personne: this.contrat.personne_id }).then(({ emplacements }) => {
        this.emplacements = emplacements
        this.loading = false
      })
    },
    getDemandes() {
      if (this.contrat.personne_id) {
        this.getByPersonne(this.contrat.personne_id).then(({ contrats }) => {
          this.emplacement = contrats.map(({ emplacement_id }) => emplacement_id)
        })
      }
    },
  },
}
</script>
<style></style>
