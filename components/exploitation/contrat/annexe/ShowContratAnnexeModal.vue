<template>
  <b-modal v-model="dialog" scrollable size="lg" hide-footer>
    <div v-if="!contrat" class="text-center">
      <b-spinner variant="primary" label="Text Centered"></b-spinner>
    </div>
    <template v-if="contrat" #modal-header>
      <h5 class="modal-title text-primary">Détails du contrat {{ contrat.code }}</h5>
      <button type="button" class="close" aria-label="Close" @click="dialog = false">
        <span aria-hidden="true"><feather type="x" /></span>
      </button>
    </template>
    <template v-if="contrat" #default>
      <div class="card card-invoice">
        <b-overlay :show="$fetchState.pending" spinner-variant="primary" rounded="sm">
          <div class="card-header">
            <div>
              <h5 class="mg-b-3">Contrat {{ contrat.code }}</h5>
              <span class="tx-sm text-muted">fait le: {{ $moment(contrat.created_at).format('ll') }}</span>
            </div>
            <div class="btn-group-invoice">
              <button class="btn btn-white btn-sm btn-uppercase">
                <feather type="printer" size="20" stroke="blue" />
              </button>
              <button class="btn btn-white btn-sm btn-uppercase">
                <feather type="mail" size="20" stroke="blue" />
              </button>
              <button v-if="validable" class="btn btn-brand-02 btn-sm btn-uppercase" @click="valider">
                <feather type="check-circle" size="20" stroke="white" />
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-sm-4 col-lg-4">
                <h6 v-if="enterprise.sigle" class="tx-15 mg-b-10">{{ enterprise.sigle }}</h6>
                <p v-if="enterprise.siege" class="mg-b-0">{{ enterprise.siege }}</p>
                <p v-if="enterprise.phone" class="mg-b-0">Telephone: {{ enterprise.phone }}</p>
                <p v-if="enterprise.email" class="mg-b-0">Email: {{ enterprise.email }}</p>
              </div>
              <div class="col-sm-4 col-lg-4">
                <!-- <label class="content-label">facturé à</label> -->
                <h6 class="tx-15 mg-b-10">{{ contrat.personne.alias }}</h6>
                <p class="mg-b-0">{{ contrat.personne.ville }}</p>
                <p class="mg-b-0">{{ contrat.personne.contact }}</p>
                <p v-if="contrat.personne.email" class="mg-b-0">
                  {{ contrat.personne.email }}
                </p>
              </div>
              <!-- col -->
              <div class="col-sm-4 col-lg-4">
                <!-- <label class="content-label">Information du contrat</label> -->
                <ul class="list-unstyled lh-7">
                  <li class="d-flex justify-content-between">
                    <span><b>Code du contrat:</b></span>
                    <span
                      ><b>{{ contrat.code }}</b></span
                    >
                  </li>
                  <li class="d-flex justify-content-between">
                    <span>Début: </span>
                    <span>{{ $moment(contrat.debut).format('DD-MM-YYYY') }} </span>
                  </li>
                  <li class="d-flex justify-content-between">
                    <span>Fin: </span>
                    <span>{{ $moment(contrat.debut).add(1, 'Y').format('DD-MM-YYYY') }}</span>
                  </li>
                </ul>
              </div>
              <!-- col -->
            </div>
            <!-- row -->
            <h5 class="mg-t-25">Produit Annexe</h5>
            <div class="table-responsive">
              <table class="table table-invoice bd-b">
                <thead>
                  <tr>
                    <th class="wd-30p">Nom</th>
                    <th class="wd-50p d-none d-sm-table-cell">Description</th>
                    <th class="tx-center">Prix</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="tx-nowrap">{{ contrat.annexe.nom }}</td>
                    <td class="d-none d-sm-table-cell tx-color-03">
                      {{ contrat.annexe.description }}
                    </td>
                    <td class="tx-center">
                      {{ contrat.factures[0].montant | currency }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="row justify-content-between mg-t-25">
              <div class="col-sm-6 col-lg-6 order-2 order-sm-0 mg-t-40 mg-sm-t-0">
                <!-- <label class="content-label mg-b-10">Notez bien</label>
                <p class="tx-sm">
                  Sed ut perspiciatis unde omnis iste natus error sit voluptatem
                  accusantium doloremque laudantium, totam rem aperiam, eaque ipsa
                  quae ab illo inventore veritatis et quasi architecto beatae
                  vitae dicta sunt explicabo.
                </p> -->
              </div>
              <!-- col -->
              <div class="col-sm-6 col-lg-4 order-1 order-sm-0">
                <ul class="list-unstyled lh-7 pd-r-10">
                  <li class="d-flex justify-content-between">
                    <strong>Total</strong>
                    <strong>{{ total | currency }} </strong>
                  </li>
                </ul>
                <button v-if="validable" class="btn btn-block btn-primary btn-brand-02" @click="valider">
                  valider
                </button>
              </div>
            </div>
          </div>
        </b-overlay>
      </div>
    </template>
  </b-modal>
</template>

<script>
import { mapActions, mapGetters } from 'vuex'
import { CONTRAT } from '~/helper/constantes'
import { MODULES } from '~/helper/modules-types'
import modal from '~/mixins/modal'
export default {
  mixins: [modal],
  props: {
    id: { type: Number, required: true },
  },
  data: () => ({
    STATUS: CONTRAT.status,
    contrat: null,
  }),
  async fetch() {
    try {
      await this.getSociete()
    } catch (error) {
      this.$notify({ text: error.response.data.message, type: 'error', title: 'Echec Autorisation' })
    }
    const { contrat } = await this.getOne(this.id)
    this.contrat = contrat
  },
  computed: {
    validable() {
      return this.contrat.status === this.STATUS.attente
    },
    total() {
      return this.contrat.factures[0].montant
    },
    ...mapGetters({ enterprise: MODULES.APPLICATION.GETTERS.SOCIETE }),
  },
  methods: {
    ...mapActions({
      getValider: MODULES.CONTRAT.ANNEXE.ACTIONS.SCHEDULE,
      getOne: MODULES.CONTRAT.ANNEXE.ACTIONS.ONE,
      getSociete: MODULES.APPLICATION.ACTIONS.ONE,
    }),
    valider() {
      this.getValider(this.contrat.id).then(({ message }) => {
        this.$notify({ text: message, title: "succès de l'opération", type: 'success' })
        this.dialog = false
      })
    },
  },
}
</script>

<style></style>
